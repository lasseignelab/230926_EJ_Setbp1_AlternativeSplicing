---
title: "Create Figure 3 and 4"
author: "Emma Jones"
date: "2024-04-22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Create figures 3 and 4

The purpose of this script is to make and complete figures 3 and 4. Figure 3 has an upset plot of all alternatively spliced genes, and Figure 4 has functional enrichment analysis of cell-type specific AS genes.

## Load packages

```{r load packages}
suppressPackageStartupMessages({
  library(tidyverse)
  library(here)
  library(styler)
  library(lintr)
  library(cowplot)
  library(patchwork)
  library(viridis)
  library(org.Mm.eg.db)
  library(gprofiler2)
  library(AnnotationDbi)
  library(clusterProfiler)
  library(ComplexHeatmap)
  library(readxl)
})
```


```{r load marvel object and significant gene tables}
# Load MARVEL object
setbp1_marvel <- read_rds(here::here(
  "data", "marvel",
  "setbp1_marvel_aligned.rds"
))

# Retrieve sample metadata
sample_metadata <- setbp1_marvel$sample.metadata

# Load significant gene tables
load(here::here("data", "marvel", "significant_tables.RData"))

# Pull cell types and matching ids
cell_group_list <- sample_metadata %>%
  group_split(cell_type, .keep = TRUE) %>%
  map(~ set_names(.$cell.id, .$cell_type[1]))

# Rename
cell_group_list <- set_names(cell_group_list, c(
  "Astrocytes", "Excitatory Neurons",
  "Inhibitory Neurons", "Microglia", "OPCs",
  "Oligodendrocytes", "Vascular Cells"
))
```

### Prep data for UpSet Plot with ComplexHeatmap

```{r make upset plot}
# make list of sig tables
tables_list <- mget(ls(pattern = "_sig_table"))

# remove all cell types from list
tables_list <- tables_list[2:8]

# pull out only genes
gene_lists <- map(tables_list, ~ select(.x, gene_short_name))

# make into character list
gene_lists <- map(gene_lists, ~ flatten(.))

# create matrix
gene_lists_mat <- ComplexHeatmap::list_to_matrix(gene_lists)

# rename columns
colnames(gene_lists_mat) <- c(
  "Astrocytes", "Excitatory Neurons",
  "Inhibitory Neurons", "Microglia",
  "Oligodendrocytes", "OPCs", "Vascular Cells"
)

# generate combination matrix
gene_lists_comb_mat <- make_comb_mat(gene_lists_mat)
```

### Draw and save UpSet Plot

```{r draw and save upsetplot}
gene_lists_upset_plot <- UpSet(gene_lists_comb_mat,
  comb_col = viridis(8)[2:7][comb_degree(gene_lists_comb_mat)],
  top_annotation = upset_top_annotation(gene_lists_comb_mat,
    add_numbers = TRUE, annotation_name_gp = gpar(fontface = "bold"),
    axis_param = list(gp = gpar(fontface = "bold")),
    numbers_gp = gpar(fontface = "bold")
  ),
  right_annotation = upset_right_annotation(gene_lists_comb_mat,
    add_numbers = TRUE, annotation_name_gp = gpar(fontface = "bold"),
    axis_param = list(gp = gpar(fontface = "bold")),
    numbers_gp = gpar(fontface = "bold")
  ),
  row_names_gp = gpar(fontface = "bold")
)

# view upsetplot
gene_lists_upset_plot
```


```{r save figure 3}
# save
png(here::here("results", "final_outputs", "figure3.png"),
  width = 10, height = 4, units = "in", res = 300
)
gene_lists_upset_plot
dev.off()
```

There is one gene that has significant change in splice junction usage in all non-vascular cell types. This is the Son gene.

## FEA for each cell type - Figure 4

```{r get background genes}
background_genes <- setbp1_marvel[["gene.count.matrix"]]@Dimnames[[1]]
```

To avoid aggregating cells and losing specific signals, lets only include genes from each cell type.

```{r run fea on each cell type}
cell_type_goresults <- lapply(gene_lists, function(x) {
  neuron_gostres <- gost(
    query = unlist(x),
    organism = "mmusculus", ordered_query = FALSE,
    multi_query = FALSE, significant = TRUE, exclude_iea = FALSE,
    measure_underrepresentation = FALSE, evcodes = TRUE,
    user_threshold = 0.05, correction_method = "g_SCS",
    domain_scope = "custom", custom_bg = background_genes,
    numeric_ns = "", sources = NULL, as_short_link = FALSE
  )
})
```

```{r save and plot new go results}
# save rds
write_rds(
  cell_type_goresults,
  here::here("data", "marvel", "cell_type_goresults.rds")
)
```

```{r plot oligodendrocytes and excitatory neuron terms}
excitatory_panel <- ggplot(
  cell_type_goresults[["excitatory_sig_table"]][["result"]],
  aes(
    x = precision,
    y = reorder(term_name, -p_value),
    size = intersection_size,
    color = p_value
  )
) +
  geom_point() +
  scale_color_viridis(direction = 1, option = "mako") +
  theme_minimal(base_size = 12) +
  theme(
    axis.title = element_text(face = "bold"),
    axis.text = element_text(face = "bold", color = "black"),
    legend.text = element_text(face = "bold"),
    legend.title = element_text(face = "bold"),
    title = element_text(face = "bold")
  ) +
  xlab("Precision") +
  ylab("Term Name") +
  labs(color = "p-value", size = "Intersection Size") +
  ggtitle("Excitatory Neuron Functional\nEnrichment Analysis") +
  guides(
    size = guide_legend(order = 1),
    color = guide_colorbar(order = 2)
  )

excitatory_panel

oligo_panel <- ggplot(
  cell_type_goresults[["oligodendrocytes_sig_table"]][["result"]],
  aes(
    x = precision,
    y = reorder(term_name, -p_value),
    size = intersection_size,
    color = p_value
  )
) +
  geom_point() +
  scale_color_viridis(direction = 1, option = "mako") +
  theme_minimal(base_size = 12) +
  theme(
    axis.title = element_text(face = "bold"),
    axis.text = element_text(face = "bold", color = "black"),
    legend.text = element_text(face = "bold"),
    legend.title = element_text(face = "bold"),
    title = element_text(face = "bold")
  ) +
  xlab("Precision") +
  ylab("Term Name") +
  labs(color = "p-value", size = "Intersection Size") +
  ggtitle("Oligodendrocyte Functional\nEnrichment Analysis") +
  guides(
    size = guide_legend(order = 1),
    color = guide_colorbar(order = 2)
  )

oligo_panel
```

```{r make supp information for other cell types}
inhibitory_panel <- ggplot(
  cell_type_goresults[["inhibitory_sig_table"]][["result"]],
  aes(
    x = precision,
    y = reorder(term_name, -p_value),
    size = intersection_size,
    color = p_value
  )
) +
  geom_point() +
  scale_color_viridis(direction = 1, option = "mako") +
  theme_minimal(base_size = 12) +
  theme(
    axis.title = element_text(face = "bold"),
    axis.text = element_text(face = "bold", color = "black"),
    legend.text = element_text(face = "bold"),
    legend.title = element_text(face = "bold"),
    title = element_text(face = "bold")
  ) +
  xlab("Precision") +
  ylab("Term Name") +
  labs(color = "p-value", size = "Intersection Size") +
  ggtitle("Inhibitory Neuron Functional\nEnrichment Analysis") +
  guides(
    size = guide_legend(order = 1),
    color = guide_colorbar(order = 2)
  )

inhibitory_panel

vascular_panel <- ggplot(
  cell_type_goresults[["vascular_sig_table"]][["result"]],
  aes(
    x = precision,
    y = reorder(term_name, -p_value),
    size = intersection_size,
    color = p_value
  )
) +
  geom_point() +
  scale_color_viridis(direction = 1, option = "mako") +
  theme_minimal(base_size = 12) +
  theme(
    axis.title = element_text(face = "bold"),
    axis.text = element_text(face = "bold", color = "black"),
    legend.text = element_text(face = "bold"),
    legend.title = element_text(face = "bold"),
    title = element_text(face = "bold")
  ) +
  xlab("Precision") +
  ylab("Term Name") +
  labs(color = "p-value", size = "Intersection Size") +
  ggtitle("Vascular Cell Functional\nEnrichment Analysis") +
  guides(
    size = guide_legend(order = 1),
    color = guide_colorbar(order = 2)
  )

vascular_panel
```


```{r format and save figure 4}
figure_4 <- plot_grid(excitatory_panel, oligo_panel,
  inhibitory_panel, vascular_panel,
  labels = c("A", "B", "C", "D"), nrow = 2
)

figure_4

# save
png(here::here("results", "final_outputs", "figure4.png"),
  width = 15, height = 15, units = "in", res = 300
)
figure_4
dev.off()
```


## Compare my 34 genes to 38 splicing genes in blood

This supplementary table was downloaded from https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9490002/ 

```{r compare to splicing genes in blood}
blood_aberrantly_spliced <- read_xlsx(
  path = here("doc", "Data_Sheet_2.xlsx"),
  sheet = 2, skip = 1
)

# there is a mistake in their table and unknown genes all have the same gene
# symbol (KNOWN) even though they have different locations

# the authors of the paper count this as 38 genes, when it is only 37
blood_aberrantly_spliced$hgncSymbol[
  blood_aberrantly_spliced$hgncSymbol == "KNOWN"
] <- NA

# drop na
blood_aberrantly_spliced <- drop_na(blood_aberrantly_spliced)

blood_aberrantly_spliced_genes <- unique(blood_aberrantly_spliced$hgncSymbol)

# convert human to mouse
source(here("src", "seurat", "functions.R"))
mouse_blood_spliced_genes <-
  convert_human_gene_list(blood_aberrantly_spliced_genes)

# get sig tables
matching_dfs <- mget(ls(pattern = "sig_table"))

# get the column you want
as_genes <- unique(unlist(lapply(matching_dfs, function(df_name) {
  df_name$gene_short_name
})))

# look at overlap
overlapping_genes <- intersect(mouse_blood_spliced_genes, as_genes)

# no overlap
```

#### Style

```{r tidy script}
style_file("figure_3-4.Rmd")

lint("figure_3-4.Rmd",
  linters = linters_with_defaults(
    object_length_linter = NULL,
    object_name_linter = NULL,
    object_usage_linter = NULL
  )
)
```

#### Software versions

My software versions will be commented below.

```{r versions}
sessionInfo()
```
R version 4.3.1 (2023-06-16)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 22.04.3 LTS

Matrix products: default
BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3 
LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.20.so;  LAPACK version 3.10.0

locale:
 [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C               LC_TIME=en_US.UTF-8       
 [4] LC_COLLATE=en_US.UTF-8     LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
 [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                  LC_ADDRESS=C              
[10] LC_TELEPHONE=C             LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       

time zone: Etc/UTC
tzcode source: system (glibc)

attached base packages:
[1] grid      stats4    stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] biomaRt_2.56.1        readxl_1.4.3          ComplexHeatmap_2.16.0 clusterProfiler_4.8.3
 [5] gprofiler2_0.2.3      org.Mm.eg.db_3.17.0   AnnotationDbi_1.62.2  IRanges_2.34.1       
 [9] S4Vectors_0.38.2      Biobase_2.60.0        BiocGenerics_0.46.0   viridis_0.6.4        
[13] viridisLite_0.4.2     patchwork_1.1.3       cowplot_1.1.1         lintr_3.1.0          
[17] styler_1.10.2         here_1.0.1            lubridate_1.9.3       forcats_1.0.0        
[21] stringr_1.5.1         dplyr_1.1.4           purrr_1.0.2           readr_2.1.4          
[25] tidyr_1.3.0           tibble_3.2.1          ggplot2_3.5.0         tidyverse_2.0.0      

loaded via a namespace (and not attached):
  [1] splines_4.3.1               BiocIO_1.10.0               filelock_1.0.2             
  [4] bitops_1.0-7                ggplotify_0.1.2             R.oo_1.25.0                
  [7] cellranger_1.1.0            polyclip_1.10-6             XML_3.99-0.14              
 [10] rex_1.2.1                   lifecycle_1.0.4             doParallel_1.0.17          
 [13] rprojroot_2.0.3             processx_3.8.2              lattice_0.21-8             
 [16] MASS_7.3-60                 backports_1.4.1             magrittr_2.0.3             
 [19] plotly_4.10.3               rmarkdown_2.25              yaml_2.3.7                 
 [22] remotes_2.4.2.1             DBI_1.1.3                   RColorBrewer_1.1-3         
 [25] abind_1.4-5                 zlibbioc_1.46.0             R.cache_0.16.0             
 [28] GenomicRanges_1.52.1        R.utils_2.12.2              ggraph_2.1.0               
 [31] RCurl_1.98-1.12             yulab.utils_0.1.0           rappdirs_0.3.3             
 [34] tweenr_2.0.2                circlize_0.4.15             GenomeInfoDbData_1.2.10    
 [37] enrichplot_1.20.3           ggrepel_0.9.5               tidytree_0.4.5             
 [40] DelayedArray_0.26.7         codetools_0.2-19            DOSE_3.26.2                
 [43] xml2_1.3.5                  ggforce_0.4.1               tidyselect_1.2.1           
 [46] shape_1.4.6                 aplot_0.2.2                 farver_2.1.1               
 [49] BiocFileCache_2.8.0         matrixStats_1.0.0           GenomicAlignments_1.36.0   
 [52] jsonlite_1.8.7              GetoptLong_1.0.5            tidygraph_1.2.3            
 [55] iterators_1.0.14            foreach_1.5.2               progress_1.2.2             
 [58] tools_4.3.1                 treeio_1.24.3               Rcpp_1.0.12                
 [61] glue_1.7.0                  gridExtra_2.3               xfun_0.40                  
 [64] MatrixGenerics_1.12.3       qvalue_2.32.0               GenomeInfoDb_1.36.4        
 [67] withr_3.0.0                 fastmap_1.1.1               fansi_1.0.6                
 [70] callr_3.7.3                 digest_0.6.33               timechange_0.2.0           
 [73] R6_2.5.1                    gridGraphics_0.5-1          colorspace_2.1-0           
 [76] GO.db_3.17.0                RSQLite_2.3.1               R.methodsS3_1.8.2          
 [79] utf8_1.2.4                  generics_0.1.3              data.table_1.14.8          
 [82] rtracklayer_1.60.1          prettyunits_1.2.0           S4Arrays_1.0.6             
 [85] graphlayouts_1.0.1          httr_1.4.7                  htmlwidgets_1.6.2          
 [88] scatterpie_0.2.1            pkgconfig_2.0.3             gtable_0.3.4               
 [91] blob_1.2.4                  XVector_0.40.0              shadowtext_0.1.2           
 [94] htmltools_0.5.6.1           fgsea_1.26.0                clue_0.3-65                
 [97] scales_1.3.0                cyclocomp_1.1.1             png_0.1-8                  
[100] ggfun_0.1.3                 knitr_1.44                  rstudioapi_0.15.0          
[103] tzdb_0.4.0                  reshape2_1.4.4              rjson_0.2.21               
[106] curl_5.1.0                  nlme_3.1-163                cachem_1.0.8               
[109] GlobalOptions_0.1.2         parallel_4.3.1              HDO.db_0.99.1              
[112] restfulr_0.0.15             desc_1.4.2                  pillar_1.9.0               
[115] vctrs_0.6.5                 dbplyr_2.3.4                cluster_2.1.4              
[118] evaluate_0.22               cli_3.6.2                   compiler_4.3.1             
[121] Rsamtools_2.16.0            rlang_1.1.3                 crayon_1.5.2               
[124] labeling_0.4.3              ps_1.7.5                    plyr_1.8.9                 
[127] fs_1.6.3                    stringi_1.8.1               BiocParallel_1.34.2        
[130] munsell_0.5.1               Biostrings_2.68.1           lazyeval_0.2.2             
[133] GOSemSim_2.26.1             Matrix_1.6-1.1              hms_1.1.3                  
[136] bit64_4.0.5                 KEGGREST_1.40.1             SummarizedExperiment_1.30.2
[139] igraph_1.5.1                memoise_2.0.1               ggtree_3.8.2               
[142] fastmatch_1.1-4             bit_4.0.5                   xmlparsedata_1.0.5         
[145] downloader_0.4              ape_5.7-1                   gson_0.1.0

