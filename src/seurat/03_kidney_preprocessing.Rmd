---
title: "03_kidney_preprocessing"
author: "Tabea M. Soelter"
date: "2025-07-11"
output: html_document
---
**Pre-processing of S858R mouse kidney data**

__Goal__: Process S858R (snRNA-seq) kidney data for downstream analyses. The
data consists of 2 conditions (S858R-mutants, wildtype) and 1 sex (male).
  
__Reproducibility__:
* GitHub: lasseignelab/230926_EJ_Setbp1_AlternativeSplicing
* Docker: emmafjones/setbp1_alternative_splicing
    * Version: 1.1.0 
* HPC: Yes
  * Resources: long partition (150hrs), 4 CPUs, 65GB per CPU

__Data__:
* Name: N/A
* Location: 230926_EJ_Setbp1_AlternativeSplicing/data/soupX/

__Analysis Plan__:
* Load necessary packages 
* Load data 
* Create seurat object
* Perform quality control and filtering
* Integration
* Save integrated seurat object

__Analysis__:
# Load packages
```{r}
# Time tracking
ptm <- proc.time()

# Setting seed
set.seed(42)

# Load packages
suppressPackageStartupMessages({
  library(Seurat)
  library(tidyverse)
  library(harmony)
  library(stringr)
  library(gprofiler2)
  library(here)
  library(styler)
  library(lintr)
})

source(here("src", "functions_soelter.R"))
source(here("src", "seurat", "functions.R"))
```

```{r}
## make_seurat_object
# A function which takes a path to sample folders with the three CellRanger output files and creates a merged seurat object
make_seurat_object <- function(path){
  counts_list <- list.dirs(path, 
                           full.names = TRUE, 
                           recursive = FALSE)
  counts_list <- grep("K", counts_list, value = TRUE)
  object_list <- vector('list')
  for (i in counts_list){
    counts <- Read10X(i)
    print(i)
    sample_name <- basename(i)
    seurat_object <- CreateSeuratObject(counts = counts, project = sample_name, min.features = 200)
    if (substring(sample_name, nchar(sample_name)) %in% c("1", "3", "5")) {
      seurat_object$orig.ident <- "wildtype"
    } else {
      seurat_object$orig.ident <- "mutant"
    }
    seurat_object$sample_id <- sample_name
    object_list[[i]] <- seurat_object
  } 
  print("Making wildtype Seurat Object")
  WT_list <- object_list[grepl("K[135]", names(object_list))]
  for (i in names(WT_list)) {
    sample_name <- basename(i)
    WT_list[[i]] <- RenameCells(WT_list[[i]],
                                add.cell.id = sample_name)
  }
  wildtypes <- Merge_Seurat_List(WT_list)
  
  print("Making mutant Seurat Object")
  mutant_list <- object_list[grepl("K[246]", names(object_list))]
  for (i in names(mutant_list)) {
    sample_name <- basename(i)
    mutant_list[[i]] <- RenameCells(mutant_list[[i]],
                                  add.cell.id = sample_name)
  }
  mutants <- Merge_Seurat_List(mutant_list)
  
  print("Making merged Seurat Object")
  merged_seurat <- merge(x = wildtypes,
                         y = mutants,
                         add.cell.id = c("WT", "S858R"))
  return(merged_seurat)
}
```

```{r}
merged_seurat <- make_seurat_object(here(
  "data",
  "soupX"
))
```

```{r}
merged_seurat <- calculate_qc(merged_seurat)
```




